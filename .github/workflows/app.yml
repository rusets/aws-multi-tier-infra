name: app

on:
  workflow_call:
    inputs:
      param_path:
        type: string
        required: true
      aws_region:
        type: string
        required: true
    secrets:
      APP_ROLE_ARN:
        required: true

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ inputs.aws_region }}
  PARAM_PATH: ${{ inputs.param_path }}

concurrency:
  group: app-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy-app:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.APP_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Build or package app (content-hash)
        id: pack
        run: |
          set -euo pipefail
          if [ -f app/package.json ]; then
            pushd app >/dev/null
            if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
              npm ci --omit=dev
            else
              npm install --omit=dev
            fi
            npm run build || true
            popd >/dev/null
            zip -r app-build.zip app -x "app/node_modules/**" "app/.cache/**"
          else
            if [ -d app/public ]; then
              (cd app && zip -r ../app-build.zip public)
            else
              echo "No app/package.json and no app/public â€” nothing to package" >&2
              exit 1
            fi
          fi
          if command -v md5sum >/dev/null 2>&1; then
            MD5=$(md5sum app-build.zip | awk '{print $1}')
          else
            MD5=$(md5 -q app-build.zip)
          fi
          SHORT=${MD5:0:7}
          NAME="app-${SHORT}.zip"
          mv -f app-build.zip "$NAME"
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "md5=$MD5"   >> $GITHUB_OUTPUT

      - name: Detect artifact change by MD5
        id: diff
        run: |
          set -euo pipefail
          CURRENT="$(aws ssm get-parameter --name "${PARAM_PATH}/app/artifact_md5" --query 'Parameter.Value' --output text 2>/dev/null || echo '')"
          NEW="${{ steps.pack.outputs.md5 }}"
          if [ "$NEW" = "$CURRENT" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi
          echo "current_md5=$CURRENT" >> $GITHUB_OUTPUT
          echo "new_md5=$NEW"         >> $GITHUB_OUTPUT

      - name: Get assets bucket from SSM (only if changed)
        if: steps.diff.outputs.changed == 'true'
        id: ssm
        run: |
          set -euo pipefail
          BUCKET=$(aws ssm get-parameter --name "${PARAM_PATH}/assets_bucket" --query 'Parameter.Value' --output text)
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT

      - name: Upload artifact to S3 (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail
          aws s3 cp "${{ steps.pack.outputs.name }}" "s3://${{ steps.ssm.outputs.bucket }}/artifacts/${{ steps.pack.outputs.name }}"

      - name: Update SSM parameters (only if changed)
        if: steps.diff.outputs.changed == 'true'
        run: |
          set -euo pipefail
          aws ssm put-parameter --name "${PARAM_PATH}/app/artifact_key"   --type String --overwrite --value "artifacts/${{ steps.pack.outputs.name }}"
          aws ssm put-parameter --name "${PARAM_PATH}/app/artifact_md5"   --type String --overwrite --value "${{ steps.pack.outputs.md5 }}"
          aws ssm put-parameter --name "${PARAM_PATH}/app/last_deploy_sha"  --type String --overwrite --value "${GITHUB_SHA}"
          aws ssm put-parameter --name "${PARAM_PATH}/app/last_deploy_time" --type String --overwrite --value "$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
